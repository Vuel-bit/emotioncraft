<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>emotioncraft Prototype 0.1.9 — Release Loop</title>
  <style>
    :root {
      --bg: #0b0f16;
      --panel: rgba(20, 28, 43, 0.86);
      --panel2: rgba(12, 16, 26, 0.78);
      --text: #e8eefc;
      --muted: rgba(232, 238, 252, 0.7);
      --accent: #7aa2ff;
      --danger: #ff6b6b;
      --ok: #54d18d;
      --warn: #ffd166;
      --bad: #ff6b6b;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { position: fixed; inset: 0; overflow: hidden; z-index: 0; }
    canvas { display: block; width: 100vw; height: 100vh; touch-action: manipulation; position: relative; z-index: 0; }

    .hud {
      position: fixed; inset: 0; pointer-events: none;
      z-index: 5;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .topbar {
      position: absolute; top: 12px; left: 12px; right: 12px;
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
      backdrop-filter: blur(8px);
    }
    .mvpHud{
      font-size: 13px;
      color: var(--text);
      opacity: 0.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .topbar.compact{
      padding: 8px 10px;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }
    .topbar.compact .meter{ display:none; }
    .actionline{
      position:absolute;
      top: 132px; left: 12px; right: 12px;
      background: rgba(12, 16, 26, 0.78);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
      pointer-events: none;
      backdrop-filter: blur(8px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-height: 700px){
      .actionline{ top: 126px; font-size: 12px; padding: 7px 10px; }
    }


    .meter { display: grid; gap: 6px; }
    .meter .label { font-size: 12px; color: var(--muted); letter-spacing: 0.2px; }
    .bar {
      height: 12px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .bar > div { height: 100%; width: 0%; background: var(--accent); transition: width 160ms linear, background 160ms linear; }

    .buttons { display: flex; gap: 8px; }
    .levelCtl { display:flex; align-items:center; gap:6px; padding:4px 8px; border-radius:12px; background: rgba(10, 12, 18, 0.45); border: 1px solid rgba(255,255,255,0.08); }
    .levelCtl .lvlLabel { font-size: 12px; color: rgba(232, 238, 252, 0.75); }
    .levelCtl .lvlSelect { background: rgba(0,0,0,0.25); color: rgba(232, 238, 252, 0.92); border: 1px solid rgba(255,255,255,0.10); border-radius: 10px; padding: 4px 8px; font-size: 12px; outline: none; }
    .levelCtl .lvlSelect:focus { border-color: rgba(255,255,255,0.25); }
    .btn {
      pointer-events: auto;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .btn:active { transform: translateY(1px); }

    .toast {
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text);
      pointer-events: none;
      opacity: 0;
      transition: opacity 200ms ease;
      backdrop-filter: blur(10px);
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show { opacity: 1; }

    .drawer {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 12px;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }

    /* Lobby overlay (Chunk: Patient Lobby) */
    .lobbyOverlay{
      position: fixed;
      inset: 0;
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(8, 10, 14, 0.82);
      backdrop-filter: blur(8px);
    }
    .lobbyOverlay.show{ display:flex; }
    .lobbyCard{
      width: min(820px, 100%);
      max-height: min(86vh, 760px);
      overflow: auto;
      background: rgba(20, 28, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
    }
    .lobbyHeader{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom: 10px; }
    .lobbyHeader h2{ margin:0; font-size: 16px; letter-spacing: 0.2px; }
    .lobbyHeader .sub{ font-size: 12px; color: rgba(232,238,252,0.72); }
    .patientList{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    .patientItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(12, 16, 26, 0.72);
      border: 1px solid rgba(255,255,255,0.10);
      cursor: pointer;
      user-select: none;
    }
    .patientItem:hover{ border-color: rgba(255,255,255,0.16); }
    .patientItem.selected{
      border-color: rgba(122, 162, 255, 0.95);
      box-shadow: 0 0 0 1px rgba(122, 162, 255, 0.35) inset;
    }
    .patientMeta{ font-size: 12px; color: rgba(232,238,252,0.76); line-height: 1.25; }
    .patientTitle{ font-size: 13px; color: rgba(232,238,252,0.95); margin-bottom: 2px; }
    .patientBadges{ display:flex; gap: 8px; align-items:center; justify-content:flex-end; }
    .pill{ font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.06); color: rgba(232,238,252,0.86); white-space:nowrap; }
    .lobbyActions{ display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px; }
    .lobbyBtn{
      pointer-events: auto;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .lobbyBtn.primary{ background: rgba(122, 162, 255, 0.18); border-color: rgba(122, 162, 255, 0.35); }
    .lobbyBtn:active{ transform: translateY(1px); }
    .drawer .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .drawer h3 { margin: 0; font-size: 14px; }
    .drawer .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* Inventory strip: 1 row (up to 10 imprints)
       Keeps the drawer short so it won’t cover vertically stacked Wells. */
    .imprints {
      margin-top: 10px;
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 2px;
      max-height: 56px;
      -webkit-overflow-scrolling: touch;
    }
    .imprints::-webkit-scrollbar { height: 6px; }
    .imprints::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 999px; }
    .invItem {
      position: relative;
      width: 46px;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      flex: 0 0 auto;
    }
    .invItem::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.10), rgba(0,0,0,0));
      pointer-events: none;
    }
    .invItem:active { transform: translateY(1px); }
    .invItem.selected {
      border-color: rgba(122, 162, 255, 0.95);
      box-shadow: 0 0 0 1px rgba(122, 162, 255, 0.35) inset;
    }
    .invItem .fill {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 0%;
      background: rgba(0,0,0,0.14);
    }
    .invItem .arrow {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: rgba(255,255,255,0.92);
      text-shadow: 0 1px 2px rgba(0,0,0,0.45);
      pointer-events: none;
    }

    .invItem .traumaMark {
      position: absolute;
      left: 6px;
      bottom: 6px;
      width: 7px;
      height: 0%;
      border-radius: 6px;
      background: rgba(0,0,0,0.72);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.10) inset;
      pointer-events: none;
    }
    .invItem .badge {
      position: absolute;
      top: 5px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      line-height: 1;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.28);
      color: rgba(255,255,255,0.92);
      font-variant-numeric: tabular-nums;
      pointer-events: none;
    }
    .invItem .badge.trauma { left: 6px; }
    .invItem .badge.cath { right: 6px; }
    .invItem .badge.amount { right: 6px; top: auto; bottom: 5px; }
    .invItem .badge.attune { left: 6px; top: auto; bottom: 5px; }

    /* Hue swatches: match the “pure” well colors from mixWellColor() */
    .invItem.hue-red { background: rgba(255, 80, 80, 0.58); }
    .invItem.hue-blue { background: rgba(100, 150, 255, 0.58); }
    .invItem.hue-yellow { background: rgba(255, 220, 90, 0.56); }
    .invItem.hue-trauma { background: rgba(0, 0, 0, 0.52); }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      color: var(--muted);
    }
    /* (Legacy .card styles retained for reference; inventory uses .invItem) */

    .debug {
      position: absolute;
      left: 12px;
      right: 12px;
      top: 170px;
      max-height: 52vh;
      overflow: auto;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.35;
      white-space: pre;
      display: none;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }
    .debug.show { display: block; }

    .fail {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.65);
      pointer-events: auto;
      backdrop-filter: blur(6px);
    }
    .fail .panel {
      width: min(520px, calc(100vw - 24px));
      background: rgba(20, 28, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 14px;
    }
    .fail h2 { margin: 0 0 6px 0; font-size: 16px; color: var(--danger); }
    .fail p { margin: 0 0 10px 0; color: var(--muted); font-size: 13px; }

    .win {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.65);
      pointer-events: auto;
      backdrop-filter: blur(6px);
    }
    .win .panel {
      width: min(520px, calc(100vw - 24px));
      background: rgba(20, 28, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 14px;
    }
    .win h2 { margin: 0 0 6px 0; font-size: 16px; color: var(--ok); }
    .win p { margin: 0 0 10px 0; color: var(--muted); font-size: 13px; }


    /* Inventory is a single-row horizontal strip; mobile uses swipe scrolling. */

    /* Prevent text selection on mobile */
    * { -webkit-tap-highlight-color: transparent; }

    /* MVP redesign controls panel (Chunk 5) */
    .ctrl{ margin-top:8px; padding:8px; border-radius:12px; background: rgba(12,16,26,0.55); border: 1px solid rgba(232,238,252,0.08); }
    .ctrlRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .ctrlRow label{ display:flex; gap:6px; align-items:center; font-size:12px; color: rgba(232,238,252,0.88); }
    .ctrlRow input[type="range"]{ accent-color: #7aa2ff; width: 120px; }
    .ctrlRow .val{ min-width:44px; text-align:right; font-variant-numeric: tabular-nums; color: rgba(232,238,252,0.85); }
    #objectivePanel{
    position:absolute;
    left:12px;
    top:64px;
    z-index:20;
    background:rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:10px;
    padding:8px 10px;
    color:#fff;
    font:12px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    max-width: calc(100vw - 24px);
    pointer-events:none;
  
    max-width: 260px;
    max-height: 220px;
    overflow:auto;
    font-size: 12px;
    line-height: 1.25;
  }
  #objectivePanel .title{font-weight:700; font-size:12px; margin-bottom:4px;}
  #objectivePanel .obj{opacity:0.92; margin-bottom:6px;}
  #objectivePanel .hold{opacity:0.92; margin-bottom:6px;}
  #objectivePanel .row{display:flex; gap:8px; align-items:baseline; margin:2px 0;}
  #objectivePanel .chk{width:14px; text-align:center; opacity:0.9;}
  #objectivePanel .h{flex:1; opacity:0.95;}
  #objectivePanel .v{opacity:0.9; font-variant-numeric:tabular-nums;}
  #objectivePanel .done{margin-top:6px; font-weight:700; color:#a7f3d0;}


  @media (max-width: 760px){
    .topbar{ grid-template-columns: 1fr; }
    .buttons{ flex-wrap: wrap; justify-content: flex-start; }
    .levelCtl{ flex: 1 1 auto; }
    .mvpHud{ white-space: normal; }
  }



  .drawerTop{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    pointer-events:auto;
  }
  .drawerLeft{ min-width: 220px; flex: 1 1 auto; }
  .drawerRight{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; flex: 0 0 auto; }
  .pill.big{ font-weight: 700; letter-spacing: 0.2px; }
  .miniBar{
    width: 180px;
    height: 6px;
    border-radius: 999px;
    background: rgba(232,238,252,0.10);
    overflow:hidden;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .miniBar > div{ height:100%; width:0%; background: rgba(122,162,255,0.95); border-radius: 999px; }

  /* Controls: tighter + wrap on narrow screens */
  .ctrlRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .ctrlRow label{ display:flex; align-items:center; gap:8px; }
  #deltaA{ width: 180px; }
  #deltaS{ width: 300px; }
  @media (max-width: 720px){
    #deltaS{ width: 240px; }
    #deltaA{ width: 160px; }
    .drawerRight{ align-items:flex-start; }
    .miniBar{ width: 160px; }
  }
</style>
</head>
<body>
<div id="app"></div>

  <!-- Patient Lobby overlay (hidden until initialized) -->
  <div id="lobbyOverlay" class="lobbyOverlay" aria-hidden="true">
    <div class="lobbyCard">
      <div class="lobbyHeader">
        <div>
          <h2>Patient Lobby</h2>
          <div class="sub">Select a patient to begin a session.</div>
        </div>
        <div class="sub" id="lobbyHint"></div>
      </div>
      <div id="patientList" class="patientList"></div>
      <div class="lobbyActions">
        <button id="btnLobbyStart" class="lobbyBtn primary">Start Session</button>
      </div>
    </div>
  </div>

<div class="hud">
  <div class="topbar">
    <div class="meter" id="legacyMeters">
      <div class="label" id="collapseLabel">Collapse</div>
      <div class="bar"><div id="loseFill"></div></div>
      <div class="label" id="goalLabel" style="margin-top:6px;">Stabilization</div>
      <div class="bar"><div id="winFill"></div></div>
    </div>
    <div class="mvpHud" id="mvpHud"></div>
    <div class="buttons">
      <button class="btn" id="btnReset">Reset</button>
      <div class="levelCtl">
        <span class="lvlLabel">Level</span>
        <select id="levelSelect" class="lvlSelect">
          <option value="1">Level 1</option>
          <option value="2">Level 2</option>
        </select>
      </div>
      <button class="btn" id="btnDebug">Debug</button>
    </div>
  </div>

  <!-- action line removed for MVP redesign (Chunk 5) -->

  <div class="debug" id="debug"></div>

  <div id="objectivePanel"></div>

  <div class="drawer" id="drawer">
    <div class="drawerTop">
      <div class="drawerLeft">
        <div class="drawerTitleRow">
          <h3 id="drawerTitle">Controls</h3>
          <div class="sub" id="drawerSub">Select a Well, set targets, preview Cost, then Apply.</div>
        </div>
        <div class="sub" id="objectiveSummary">Level — Objective</div>
      </div>

      <div class="drawerRight">
        <div class="pill" id="selectedWellPill">Selected: None</div>
        <div class="pill big" id="energyCostPill">Energy: 0 / 0 (+0.00/s) | Cost: 0.0</div>
        <div class="miniBar" aria-hidden="true"><div id="energyMiniFill"></div></div>
      </div>
    </div><div class="ctrl" id="ctrlPanel">
      <div class="ctrlRow">
        <label>Amount
          <input type="range" id="deltaA" min="25" max="100" step="5" value="25" />
          <span class="val" id="deltaAVal">25</span>
        </label>

        <label>Spin
          <input type="range" id="deltaS" min="-100" max="100" step="2" value="0" />
          <span class="val" id="deltaSVal">0</span>
        </label>

        <button class="btn" id="btnSpinZero">Set Spin 0</button>
        <button class="btn" id="btnZeroPair">Zero Pair</button>

        <div class="pill" id="costPill">Cost: 0</div>
        <button class="btn primary" id="btnApply">Apply</button>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
        <div class="pill" id="previewPill">Current: - | Target: - | Cost: 0 | Opp: 0</div>
      </div>
          </div>
  </div>

  <div class="toast" id="toast"></div>



  <div class="win" id="win">
    <div class="panel">
      <h2>Mindform stabilized</h2>
      <p id="winReason">You held the line long enough for the currents to settle.</p>
      <div id="runSummary" style="white-space:pre-line; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 11px; color: rgba(232, 238, 252, 0.85); margin: 10px 0 12px 0;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="btnWinReset">New Run</button>
      </div>
    </div>
  </div>

  <div class="fail" id="fail">
    <div class="panel">
      <h2>Mindform destabilized</h2>
      <p id="failReason">Instability exceeded safe limits.</p>
      <div id="runSummaryFail" style="white-space:pre-line; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 11px; color: rgba(232, 238, 252, 0.85); margin: 10px 0 12px 0;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="btnFailReset">Reset Run</button>
      </div>
    </div>
  </div>
</div>

<!-- PixiJS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@7.4.2/dist/pixi.min.js"></script>
<script src="ec_bootstrap.js"></script>
<script src="core_const.js"></script>
<script src="core_tuning.js"></script>
<script src="core_model.js"></script>
<script src="systems_patients.js"></script>
<script src="systems_dispositions.js"></script>
<script src="systems_breaks.js"></script>
<script src="render_wells_init.js"></script>
<script src="render_wells_update.js"></script>
<script src="render_wells.js"></script>
<script src="core_mechanics.js"></script>
<script src="ui_hud.js"></script>
<script src="ui_lobby.js"></script>
<script src="ui_controls.js"></script>
<script src="ui_app.js"></script>
<script src="main.js"></script>
</body>
</html>
