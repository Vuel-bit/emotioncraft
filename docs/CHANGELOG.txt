## v0_2_103_passD (2026-02-12)
- passA39 — Hotfix (UI/visual only): fixed ui_controls spin button cost label crash; forced energy/timer HUD anchors to auto (prevents stretched right-side shading); fully hid legacy ctrlPanel strip. No mechanics changes.
- passA37 — Visual-only/UI-only: Psyche wedges upgraded to vivid, clearly animated "plasma depth" (crisp wedge masks, no muting). HUD presentation updated: traits are pills; quirks are colored text, with ACTIVE quirks switching to colored pills. Board UI layout repositioned via live well geometry (energy + timer top-right; portrait above orange; Spin-0 buttons over the board with two-line labels/cost). Drawer shows more plan text.
- passA36 — Visual-only: spill FX magnitude now shown via discrete traveling pulses (one per ~1 unit transferred) using per-tick Abs deltas + seq; spin stream is a stronger corkscrew; psyche depth FX preserves hue identity and animates more clearly (crisp wedge masks).
- passA35 — Visual-only: spill FX triggers earlier + is stable (abs-activity telemetry + hold timers); thickness scaling improved; psyche wedges gain subtle “well depth at rest” interior FX with crisp edges.
- passA34 — Visual-only: spin reads even faster (~2× A33); spill FX now clearly visible; amount vs spin spill streams differentiated (spin supports positive + negative).
- passA33 — Visual-only: spin reads 3× faster; added spill stream FX (ribbon + droplets). Added render telemetry for spill edges (no mechanics changes).
- passA19 — Added EC.SIM_BOOT.ensure() and replaced duplicate SIM array init in core_mechanics (structural only).
- passA15 — bracket init/reset writes via ACTIONS (resetRun + initMVP) to reduce simguard false positives.
- passD Pass 1 — boot/start hardening (main.js).
- Bootstrap: add EC._registerModule + EC.safe (debug-only warnings).
- Bootstrap: fix BUILD_ID/BUILD metadata drift (v0_2_103_passD, 2026-02-12).
- HUD: cache hot text/HTML writes to reduce per-tick DOM churn (no UI changes).
- CONST: add EC.CONST.OPP compatibility alias.
- passD Pass 2 — consolidate hue/well naming helpers (EC.hueKey/hueTitle/wellLabel*), update call sites (no text changes).
- Input: move stage pointer-up gesture resolver from main.js into systems_input.js; main now forwards stage events.
- SIM.initMVP: remove duplicate _activeLevelDef assignment and duplicate BREAK.reset block (no behavior changes).
- passD Chunk 3B — roster swap + unlock gating + start-energy progression + mood/vibe tuning + break HUD text removal.
- Dispositions (random): added global quiet/burst cadence windows (DISP_CADENCE_*), applied only to random scheduling (no force/balance math changes).
- Dispositions: implemented authoritative per-run quirk timeline buffer (SIM._quirkTimeline), event-based and capped; accumulates unshielded force per instance.
- Debug HUD: now prints quirk timeline (mm:ss start time, type, tier label, well name, unshielded force, duration, gap).
- Mental breaks: no modal popup; break details append to Log overlay. Added hit-stop + HUD toast + center/well FX.
- Psyche warning flashes restored on threshold crossing (>=450 or <=50).
- Lobby: Heroes page for Transcended; Sally portrait wired.
- Rename quirk labels: LOCKS_IN → Fixates; AMPED → Obsesses.
- Patients: last-treatment quirk naming cleanup (Fixates/Obsesses; legacy aliases).
- PLAN_CHAIN: evaluation uses rounded psyche (matches HUD numbers).
- PLAN_CHAIN: per-step holdSec supported (default 10; SPIN_ZERO 0).
- Roster: wire portraits for all patients (assets/patients/<id>.png).
- Patient WIN auto-returns to lobby to show post-win popups; reset guard per run.

- passD Chunk 3A — warn flashes + goal sync + log + break banner cleanup.
## Prior notable changes (rolled into this build lineage)
- Total Psyche cap system removed; psyche is per-hue only (0..500).
- Center core replaced with Treatment hold ring + countdown (PLAN_CHAIN).
- Zen timer standardized to 10:00 and shown in HUD during Zen.
- Set-0 costs are integer energy units (display/gate/spend match).

2026-02-13 — v0_2_103_passD_pass5
- Treatment plans: Intake is now 3 steps (no spin step; Step 3 is no-hold), Weekly is now 3 steps (removed final spin-zero step), and Zen has a new 4-step timed sequence.
- Added new timed plans: Tranquility + Transcendence.
- Progression: after Intake, choose Weekly / Zen / Tranquility; Transcendence unlocks after Zen + Tranquility are completed for that patient; transcending only occurs after completing Transcendence.
- Timed plan timer generalized to Zen/Tranquility/Transcendence; lobby plan picker updated and lobby detail panel shows Zen/Tranquility completion badges.

2026-02-13 — v0_2_103_passD_pass6
- Dispositions (random): replaced slot/cadence scheduling with a per-second tier ramp chance (0.025 / 0.05 / 0.1), capped to at most one new schedule per second, while preserving telegraph + global min-gap.
- Debug HUD: added “Copy Debug” button to copy the currently displayed debug text.

2026-02-13 — v0_2_103_passD_pass7
- Dispositions (random): ramp timers are now per-template (reset only when that quirk instance ends); mental breaks cancel pending/telegraph/active quirks and reset all ramp timers.

2026-02-14 — v0_2_103_passD_pass8
- Hotfix: quirk ramp STEP_BY_TIER corrected to 0.00025/0.0005/0.001 (was 100× too fast).
- Hotfix: All plan steps now require 10s hold except SPIN_ZERO (0s); removed holdSec:0 from non-spin steps.
- Hotfix: PLAN_CHAIN flash/advance gating hardened; fixes Tranquility Step 1 not starting hold.

2026-02-16 — v0_2_103_passD_pass18
- Added Lobby Tutorial button + primary tutorial board (mechanics walkthrough).

2026-02-16 — v0_2_103_passD_pass19
- Progression: Intake is treated as complete for all patients (no Intake gating; enforced even when loading older saves).
- Tutorial: added final win-conditions step and completion modal button; tutorial disables spillover + mental breaks.
- Normal gameplay: first-time spill + mental break popups pause and explain what happened.
- Lobby: added “?” toggle with detailed explanations for the selected patient’s Mood/Vibe/Traits/Quirks.

- Pass 20: Tutorial step 6 goal-viz + button fixes; Weekly quirk reward update; Lobby “?” info toggle fixes; Spill/break popup copy + tutorial spill disable.

Pass 21: Tutorial goalViz + Spin0/Pair0 gating flags; Grounded trait forces timed boards to 10:00; Roster reordered to 15 with Nina/Dex/Sage added and June rethemed to Juno; Lobby '?' quirks render fix + centering polish.

Pass 22: Mental break first-occurrence popups now use log-text lines (title + deltas); Grounded timer authoritative in core_mechanics fallback/clamp; Taglines corrected for Nina/Dex/Sage/Juno.

Pass 23: Spin jam first-occurrence popups now include Amount deltas (and use jam summary line as title).
Pass 24: Added core_actions.js (EC.ACTIONS facade). Routed flick/swipe + Spin0/Pair0 through EC.ACTIONS. No behavior changes.
Pass 25: Implemented EC.ACTIONS (no UI delegation). UI controls now wrap actions; added controls sync stamp for slider resync.

Pass 26: Extracted canonical ACTION_MATH (preview/cost/unit rounding/pair cost) and routed ACTIONS + UI controls to it to prevent drift.

Pass 27: Added app_loop.js (EC.APP.tickMvp). core_mechanics EC.tick delegates MVP branch to app loop. No behavior changes.

Pass 28: Added MVP pipeline module (stepMvp). core_mechanics MECH.step delegates MVP systems ordering to pipeline. No behavior changes.

Pass 29: Hotfix — Hue Break no longer references undefined msg (prevents crash). MVP tick delegation no longer falls through into legacy unless SIM.wells exists.

Pass 30: Legacy tick removed (MVP-only runtime). Inlined MVP tick into core_mechanics and removed app_loop.js. Deleted dead legacy tick helpers and unused legacy render swirl step (SIM.wells-based). No gameplay changes.
Pass 31: Inlined MVP pipeline into core_mechanics; removed the pipeline layer. No behavior changes.

Pass 32: Removed legacy Imprint/Trauma/Cleanse prototype system — deleted applyImprintToWell, IMPRINTS/getImprintById, Hue.TRAUMA, trauma tuning + trauma particles, removed boot assert and dead inventory CSS. No gameplay changes.

Pass 33 (Legacy Renderer Removal): Removed legacy SIM.wells well-view renderer and dependent core_model display/well helpers. render_wells retained only MVP layout + psyche + resize. No gameplay changes.
Pass 34: Removed stray render_wells.js.bak. Moved gesture helpers + DOM pointer bridge from render_wells into systems_input. Removed final SIM.wells legacy fallback plumbing from input. No behavior changes.
Pass 35: Main.js hygiene: removed inline input debug ladder; moved input debug recorders + touchstart arming helper into systems_input; standardized inputDbg bucket. No gameplay changes.
Pass 36: Extracted patient roster to data_roster.js (EC.DATA.ROSTER). systems_patients now consumes roster from EC.DATA. No behavior changes.
Pass 37: Extracted treatment plan specs to data_plans.js (EC.DATA.PLANS). systems_patients now consumes plan data; randomness remains in logic. No behavior changes.
Pass 38: Extracted tutorial def + step specs/copy to data_tutorial.js (EC.DATA.TUTORIAL). systems_tutorial consumes data and interprets enterOps. No behavior changes.

Pass 39: Hotfixes — restored desktop long-press drag scaling (canonical release resolver shared by DOM pointer + touch); Weekly win now reliably triggers the remove-attribute reward overlay via planKey normalization; gesture coord/debug text hidden by default (only shown with ?inputdebug=1).

Pass 40: Stage pointer-up fallback now routes through the canonical release resolver (removes duplicate flick-only logic). Weekly fallback label preserved (no underscore-normalized labels for unknown plan keys). No behavior changes.

Pass 41: Updated Tranquility plan bands/thresholds in data_plans. Persisted spill/break info popups once per user via Firestore ui.seenFirstPopups (still session-only when signed out).

Pass A1: Added core_engine.js (EC.ENGINE facade) and wired into index.html. Began enforcing architecture boundary: presentation modules do not mutate EC.SIM directly (selectWell routed through EC.ENGINE/EC.ACTIONS). Render-only layout state (mvpGeom, psycheRadius) moved to EC.RENDER_STATE.layout (render no longer writes these into SIM).

Pass A2: Added UI-facing actions (toggleAutoTest, markAutoWinHandled, ackBreakModal, recordTutLastAction) to keep presentation from mutating SIM directly. Updated ui_hud.js, ui_controls.js, and systems_input.js to route SIM mutations via EC.ENGINE.dispatch (fallback to EC.ACTIONS). Removed broken UI-side break toast timer write from ui_hud.js init; moved HUD selDrive to EC.UI_STATE.

Pass A3: Selection migrated to UI_STATE (canonical `EC.UI_STATE.selectedWellIndex`). `EC.ACTIONS.selectWell` now writes UI_STATE and mirrors SIM for compatibility. Presentation modules (ui_controls, ui_hud, render_wells_update) now read selection from UI_STATE first (SIM fallback only).

Pass A4: Lobby boundary cleanup — added `EC.ACTIONS.setInLobby` and updated ui_lobby to route all inLobby mutations via `EC.ENGINE.dispatch`/ACTIONS. ui_lobby no longer initializes EC.SIM during module load.

Pass A5: Removed SIM selectedWellIndex entirely. Selection is UI-only in EC.UI_STATE.selectedWellIndex; removed SIM mirroring + all SIM selection fallbacks (core_actions, core_model, core_action_math, ui_controls, ui_hud, render_wells_update).

Pass A6: Moved control-sync stamps (_controlsSyncStamp/_controlsSyncSel) from SIM to EC.UI_STATE (core_actions/core_model writers + ui_controls reader). Engine systems no longer assign SIM.inLobby directly; route all inLobby mutations through EC.ACTIONS.setInLobby (systems_patients, systems_tutorial).

Pass A7: Added optional debug SIM root write-guard (warn-only; enable via ?simguard=1 or UI_STATE.debugStrict). Main ticker now prefers EC.ENGINE.tick; ENGINE dispatch/tick bracket SIM writes via ENGINE._withSimWrites; direct EC.ACTIONS calls are wrapped to be bracketed when ENGINE is present.

Pass A8: Tick split into EC.tickEngine (sim mutations only) and EC.tickUI (presentation updates). EC.tick remains as a thin wrapper. EC.ENGINE.tick now brackets only tickEngine and runs tickUI outside the bracket so SIM write-guard can reliably warn on accidental UI/root SIM writes.
Pass A9: SIM write-guard improvements — ENGINE _withSimWrites now chains tags with '>' for nested contexts; direct ACTIONS wrapper only brackets when not already inside ENGINE bracket (cleaner tags); debug overlay shows sim-guard suspicious-write totals and (when ?inputdebug=1) top keys.
Pass A10: Phase 1 read-surface migration — ENGINE.getSnapshot standardized; ui_hud.js, ui_controls.js, and render_wells_update.js now read SIM/UI/RENDER via snapshot locals (defensive fallback when ENGINE missing). No behavior changes.

Pass A11: Phase 2 read-surface migration — render_wells.js, render_wells_init.js, systems_input.js, ui_lobby.js now read SIM/UI/RENDER via EC.ENGINE.getSnapshot() locals (defensive _snap fallback inside each module). No behavior changes.

Pass A12: Removed the last presentation→SIM write (SIM._uiPaused). Added `EC.ACTIONS.setUiPaused`; ui_hud Log overlay toggles pause via ENGINE.dispatch/ACTIONS. ui_hud init handlers use snapshot locals; ui_app seeds ctx from snapshot. No behavior changes.

Pass A14: SIM write-guard HUD improvements — stats now always maintain byKey counts, record up to 10 samples (key + tag chain), and the Debug panel always shows top 5 suspicious keys when simguard is enabled (samples shown only with ?inputdebug=1).

Pass A15: Bracketed init/reset entry points — resetRun + initMVP are routed through ENGINE.dispatch/ACTIONS so simguard brackets startup/reset root writes (levelState/mvpWin/mvpLose/gameOver*).

Pass A16: Patient session transitions dispatched — added ACTIONS wrappers for EC.PAT transitions and routed UI call sites (lobby + HUD) through ENGINE.dispatch/ACTIONS to prevent simguard flagging patient-session root writes.

Pass A17: Hotfixes — Weekly reward overlay restored (ui_lobby showWeeklyReward now defines `qs` from patient quirks); plan template expander now supports swapped $LO_SET/$HI_SET markers so Weekly A Step 2 goals render and evaluate correctly.

Pass A18: Added dev_smoke.html + dev_smoke.js smoke runner page (dev-only). (Index.html unchanged.)

Pass A19: Added EC.SIM_BOOT.ensure() and replaced duplicate SIM array init in core_mechanics (structural only).

Pass A20: Added EC.require deferred init hooks + improved assertReady missing-path reporting (structural only).
Pass A21: Extracted treatment plan runtime into patients_plans.js; systems_patients.js now delegates (no behavior change).
Pass A22: Render-only wells upgrade — added nebula/energy interior FX (displacement warp + wisps + subtle glow) + higher-res/LINEAR-filtered procedural textures. No gameplay changes.
Pass A23: Render-only wells update — converted interior FX to a water/fluid look (refraction via RG normal-map displacement + subtle caustics shimmer + spec highlight + fresnel rim). No gameplay changes.

Pass A24: Render-only wells update — strengthened well boundary/edge definition (two-pass rim under-stroke + fresnel top rim) and slightly stronger FX fresnel rim sprite/texture. No gameplay changes.

Pass A25: Render-only wells update — bevel-like 3-pass baseline rim (outer definition + fresnel + inner shadow), fixed spin=0 CW bias in water FX, increased visual spin read (~5x at spin=100), added always-on interior activity floor, and gated any outside-edge shading to high spins only. No gameplay changes.

Pass A26: Render-only wells update — removed always-on rim stroke lines (no solid outlines around wells), disabled the legacy wave-hand direction cue, reduced the visual spin speed boost to ~2.5x, and updated water FX so surface layers rotate/flow with omega (spin reads in the whole interior). No gameplay changes.

Pass A27: Render-only wells update — increased visual spin speed by +50% (2.5→3.75) and applied +50% omega to water FX layers; added a soft sprite mask (TEX.circle) to enforce an organic circular containment edge; re-tinted edge shading toward the well hue to form a broad color-driven border (no outline ring). No gameplay changes.

Pass A27b: Hotfix — fixed soft sprite mask visibility (maskSoft.visible=true) so SpriteMask masking works; restores well interiors rendering. No gameplay changes.

Pass A28: Added one-time “Back-Alley Psychiatry (BAP)” intro cutscene (10s) with obvious Skip + tap-anywhere skip. Persisted via Firestore save doc ui.seenIntroBAP (schema v2), with sessionStorage fallback when signed out. No gameplay changes.

Pass A29: Replaced the initial BAP intro with a cinematic 15.0s fullscreen cutscene driven by 5 plates (A–E) + DOM/CSS text/neon overlays (no baked text). Added new persistence key ui.seenIntroBAP_v3 + sessionStorage ec_seenIntroBAP_v3 so the new cutscene plays once even if the legacy intro was seen. No gameplay changes.

Pass A29b: Hotfix — intro overlay opacity now stays visible for the full cutscene duration (was incorrectly invisible until the final ~250ms). No gameplay changes.

Pass A30: BAP intro cutscene update — extended to ~30s with re-timed dialogue beats; removed DOM neon sign + Princess nametag overlays (sign/tag lettering is baked into new plate art); intro now launches the Tutorial immediately on natural end or skip (only when the cutscene actually played). Updated intro_bap plate_c/plate_d/plate_e assets. No gameplay changes.

Pass A31: BAP intro cutscene polish — fixed framing so shots start in full fit view (no negative inset; object-fit: contain); updated to a 31.0s 6-shot timeline with both Plate C variants (added plate_c_blank.png); rewrote captions + reduced constant Ken Burns (selective, smaller pushes; A pushes in only in second half). Tutorial handoff + seenIntroBAP_v3 persistence unchanged. No gameplay changes.

[2026-02-19] Pass A32 — Intro BAP: auto-advance + tap override
- docs/ui_intro_cutscene.js: replaced global timeline with per-shot state machine (auto-advance by shot duration; tap anywhere advances early; Skip still ends cutscene).
- Plate A: 2-beat caption with delayed helmet focus move (starts wide; begins push/pan at 4.0s when line 2 appears).
- Plate B: no-zoom camera; multi-beat caption sequence: Guaranteed → Probably → Most likely → Hopefully with specified hold times.
- Durations increased: C0 7s, D 6s, C1 7s, E 7s; C1 uses a stronger focus move to the upper-right sign.
- Persistence + tutorial handoff unchanged (seenIntroBAP_v3).

=== PASS A38 (2026-02-19) — UI polish: timer fit + 2-line buttons + plan text ===
- UI: Zen timer now positions below Energy with fallback alignment (left-align under Energy if fits, else right-align, else center).
- UI: Spin overlay buttons are strict 2-line labels (action + Cost), no extra lines; legacy cost spans remain hidden and no longer updated.
- UI: Spin overlay buttons align to the true green well bottom radius (no drift).
- UI: Collapsed the old bottom ctrl bar visuals so the bottom panel no longer reserves an empty strip and Treatment Plan text can use the space.
- UI: Treatment Plan goal text now renders as "Treatment Step x/y:" + 2–4 lines of constraints using ≤ only, with colored well names; current step on left, next step on right (or "Treatment complete").
