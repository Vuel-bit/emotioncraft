<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>emotioncraft Prototype 0.1.9 — Release Loop</title>
  <style>
    :root {
      --bg: #0b0f16;
      --panel: rgba(20, 28, 43, 0.86);
      --panel2: rgba(12, 16, 26, 0.78);
      --text: #e8eefc;
      --muted: rgba(232, 238, 252, 0.7);
      --accent: #7aa2ff;
      --danger: #ff6b6b;
      --ok: #54d18d;
      --warn: #ffd166;
      --bad: #ff6b6b;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      /* Mobile gesture reliability: never allow browser scroll/overscroll over the game surface */
      overscroll-behavior: none;
      touch-action: none;
    }
    #app { position: fixed; inset: 0; overflow: hidden; z-index: 0; overscroll-behavior: none; touch-action: none; }
    /* Mobile gesture reliability: prevent browser from hijacking swipes over the game surface. */
    canvas { display: block; width: 100vw; height: 100vh; touch-action: none; position: relative; z-index: 0; user-select: none; -webkit-user-select: none; }

    .hud {
      position: fixed; inset: 0; pointer-events: none;
      z-index: 5;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Board-first: always-available top notification bar (lightweight) */
    .notifyBar{
      position:absolute;
      top: 8px;
      left: 12px;
      right: 12px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(12, 16, 26, 0.55);
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(8px);
      pointer-events: none;
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      gap: 4px 8px;
    }
    .patientInfo{
      grid-column: 1;
      grid-row: 1;
      font-size: 12px;
      color: rgba(232,238,252,0.92);
      line-height: 1.15;
      /* Two-line header: name+traits on line 1, quirks on line 2 */
      white-space: pre-line;
      overflow: hidden;
    }
    /* Allow name line (Line1) to wrap so traits remain readable on mobile. */
    .hudLine2{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.92;
    }
    .hudTraitWord{
      font-weight: 800;
      margin-left: 6px;
      letter-spacing: 0.2px;
      text-shadow: 0 0 10px rgba(0,0,0,0.25);
    }
    .hudQuirkWord{
      font-weight: 900;
      margin-left: 8px;
      letter-spacing: 0.2px;
      text-shadow: 0 0 10px rgba(0,0,0,0.30);
    }
    @keyframes quirkTextGlow{
      0%{ filter: brightness(1); text-shadow: 0 0 10px rgba(0,0,0,0.30); }
      50%{ filter: brightness(1.18); text-shadow: 0 0 16px rgba(255,255,255,0.22), 0 0 10px rgba(0,0,0,0.30); }
      100%{ filter: brightness(1); text-shadow: 0 0 10px rgba(0,0,0,0.30); }
    }
    @keyframes quirkTextGlowSoft{
      0%{ filter: brightness(1); }
      50%{ filter: brightness(1.08); }
      100%{ filter: brightness(1); }
    }
    .hudQuirkTeleText{ animation: quirkTextGlowSoft 1.2s ease-in-out infinite; }
    .hudQuirkActiveText{ animation: quirkTextGlow 0.85s ease-in-out infinite; }
    .hudPatientName{
      font-weight: 800;
      margin-right: 6px;
    }
    .hudQuirkPill{
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.2px;
      color: rgba(15,18,24,0.92);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      transform: translateZ(0);
    }
    @keyframes quirkPulse{
      0%{ filter: brightness(1); box-shadow: 0 1px 6px rgba(0,0,0,0.25); }
      50%{ filter: brightness(1.25); box-shadow: 0 0 14px rgba(255,255,255,0.28); }
      100%{ filter: brightness(1); box-shadow: 0 1px 6px rgba(0,0,0,0.25); }
    }
    @keyframes quirkPulseSoft{
      0%{ filter: brightness(1); }
      50%{ filter: brightness(1.12); }
      100%{ filter: brightness(1); }
    }
    .hudQuirkActive{ animation: quirkPulse 0.9s ease-in-out infinite; }
    .hudQuirkTele{ animation: quirkPulseSoft 1.2s ease-in-out infinite; }

    .notifyText{
      grid-column: 1;
      grid-row: 2;
      font-size: 12px;
      color: rgba(232,238,252,0.78);
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .notifyControls{
      grid-column: 2;
      grid-row: 1 / span 2;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 8px;
      pointer-events: auto;
    }
    .notifyControls .btn{ padding: 6px 10px; font-size: 12px; }
    /* Level selector removed in this pass (Reset returns to lobby). */
    .topbar {
      position: absolute; top: 12px; left: 12px; right: 12px;
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
      backdrop-filter: blur(8px);
    }

    /* This pass: consolidate all top controls into the notification bar. */
    .topbar{ display:none; }

    /* Remove the upper-left objective panel from the main play screen. */
    #objectivePanel{ display:none !important; }

    /* This pass: only ONE top bar. Keep legacy topbar in DOM for compatibility but hide it. */
    .topbar{ display:none; }
    .mvpHud{
      font-size: 13px;
      color: var(--text);
      opacity: 0.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .topbar.compact{
      padding: 8px 10px;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }
    .topbar.compact .meter{ display:none; }
    .actionline{
      position:absolute;
      top: 132px; left: 12px; right: 12px;
      background: rgba(12, 16, 26, 0.78);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
      pointer-events: none;
      backdrop-filter: blur(8px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-height: 700px){
      .actionline{ top: 126px; font-size: 12px; padding: 7px 10px; }
    }


    .meter { display: grid; gap: 6px; }
    .meter .label { font-size: 12px; color: var(--muted); letter-spacing: 0.2px; }
    .bar {
      height: 12px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .bar > div { height: 100%; width: 0%; background: var(--accent); transition: width 160ms linear, background 160ms linear; }

    .buttons { display: flex; gap: 8px; }
    /* Legacy level control styling kept unused (selector removed). */
    .btn {
      pointer-events: auto;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .btn:active { transform: translateY(1px); }

    .toast {
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text);
      pointer-events: none;
      opacity: 0;
      transition: opacity 200ms ease;
      backdrop-filter: blur(10px);
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show { opacity: 1; }

    /* Always-visible gesture debug line (mobile swipe verification) */
    .gestureDebugOverlay{
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      font-size: 11px;
      line-height: 1.15;
      color: rgba(232,238,252,0.88);
      white-space: pre-line;
      pointer-events: none;
    }

    .drawer {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 12px;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }

    /* Lobby overlay (Chunk: Patient Lobby) */
    .lobbyOverlay{
      position: fixed;
      inset: 0;
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(8, 10, 14, 0.82);
      backdrop-filter: blur(8px);
    }
    .lobbyOverlay.show{ display:flex; }
    .lobbyCard{
      width: min(820px, 100%);
      max-height: min(86vh, 760px);
      overflow: auto;
      background: rgba(20, 28, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
    }
    .lobbyHeader{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 10px; }
    .lobbyHeader h2{ margin:0; font-size: 16px; letter-spacing: 0.2px; }
    .lobbyHeader .sub{ font-size: 12px; color: rgba(232,238,252,0.72); text-align:right; }

    /* Lobby auth mini-row (minimal functional scaffolding) */
    .lobbyAuth{ display:flex; justify-content:flex-end; align-items:center; gap: 8px; margin: 0 0 10px 0; flex-wrap: wrap; }
    .lobbyAuthUser{ font-size: 12px; color: rgba(232,238,252,0.72); max-width: 420px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .lobbyStartEnergy{ font-size: 12px; color: rgba(232,238,252,0.72); opacity: 0.88; white-space: nowrap; }
    .lobbyBtn[disabled]{ opacity: 0.55; cursor: not-allowed; }

    .lobbyDetails{
      display:flex;
      gap: 12px;
      align-items: stretch;
      padding: 10px;
      border-radius: 16px;
      background: rgba(12, 16, 26, 0.58);
      border: 1px solid rgba(255,255,255,0.10);
      margin-bottom: 12px;
    }
    .lobbyPortraitWrap{
      width: 120px;
      height: 120px;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      overflow: hidden;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .lobbyPortraitCol{
      display:flex;
      flex-direction: column;
      align-items: center;
      flex: 0 0 auto;
      width: 120px;
      min-width: 120px;
    }
    .lobbyMilestones{
      margin-top: 6px;
      display:flex;
      flex-wrap: nowrap;
      gap: 4px;
      justify-content: center;
      align-items: center;
      width: 100%;
      pointer-events: none;
    }
    .lobbyMsPill{
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      font-size: 10px;
      font-weight: 700;
      line-height: 1.1;
      letter-spacing: 0.1px;
    }

    #lobbyPortraitImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .lobbyDetailsText{ flex: 1 1 auto; min-width: 0; }
    .lobbyDetailsNameRow{ display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 4px; }
    .lobbyDetailsName{ font-size: 14px; color: rgba(232,238,252,0.95); margin: 0; }
    .lobbyInfoBtn{ width: 22px; height: 22px; border-radius: 11px; padding: 0; font-weight: 800; font-size: 13px; display:grid; place-items:center; line-height: 22px; }
    .lobbyDetailsHelp{ margin-top: 8px; padding: 8px 10px; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; background: rgba(0,0,0,0.18); font-size: 12px; color: rgba(232,238,252,0.82); line-height: 1.25; white-space: pre-line; }
    .lobbyDetailsTagline{ font-size: 12px; color: rgba(232,238,252,0.82); margin-bottom: 6px; }
    .lobbyDetailsMeta{ font-size: 12px; color: rgba(232,238,252,0.76); margin-bottom: 6px; line-height: 1.25; }
    .lobbyDetailsQuirks{ font-size: 12px; color: rgba(232,238,252,0.76); line-height: 1.25; }
    .patientList{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    .patientItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(12, 16, 26, 0.72);
      border: 1px solid rgba(255,255,255,0.10);
      cursor: pointer;
      user-select: none;
    }
    .patientItem:hover{ border-color: rgba(255,255,255,0.16); }
    .patientItem.selected{
      border-color: rgba(122, 162, 255, 0.95);
      box-shadow: 0 0 0 1px rgba(122, 162, 255, 0.35) inset;
    }
    .patientMeta{ font-size: 12px; color: rgba(232,238,252,0.76); line-height: 1.25; }
    .patientTitle{ font-size: 13px; color: rgba(232,238,252,0.95); margin-bottom: 2px; }
    .patientBadges{ display:flex; gap: 8px; align-items:center; justify-content:flex-end; }
    .pill{ font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.06); color: rgba(232,238,252,0.86); white-space:nowrap; }
    .lobbyActions{ display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px; }
    .lobbyBtn{
      pointer-events: auto;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .lobbyBtn.primary{ background: rgba(122, 162, 255, 0.18); border-color: rgba(122, 162, 255, 0.35); }
    .lobbyBtn:active{ transform: translateY(1px); }

    @keyframes tutPulseKey {
      0%, 100% { transform: translateY(0) scale(1.00); box-shadow: 0 0 0 rgba(255,255,255,0.0); }
      50%      { transform: translateY(-1px) scale(1.03); box-shadow: 0 0 18px rgba(255,255,255,0.18); }
    }
    .tutPulse{ animation: tutPulseKey 0.95s ease-in-out infinite; }
    .drawer .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .drawer h3 { margin: 0; font-size: 14px; }
    .drawer .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    .debug {
      position: absolute;
      left: 12px;
      right: 12px;
      top: 170px;
      max-height: 52vh;
      overflow: auto;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.35;
      white-space: pre;
      display: none;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }
    .debug.show { display: block; }
.debug .dbgTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}
.debug .dbgTitle{
  font-weight:700;
  letter-spacing:0.06em;
  opacity:0.9;
}
.debug .dbgActions{ display:flex; gap:8px; }
.debug .dbgBtn{
  font: inherit;
  font-size: 11px;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
}
.debug .dbgBtn:active{ transform: translateY(1px); }
.debug .dbgPre{
  margin: 0;
  white-space: pre;
}


    .fail {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.65);
      pointer-events: auto;
      backdrop-filter: blur(6px);
    }
    .fail .panel {
      width: min(520px, calc(100vw - 24px));
      background: rgba(20, 28, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 14px;
    }
    .fail h2 { margin: 0 0 6px 0; font-size: 16px; color: var(--danger); }
    .fail p { margin: 0 0 10px 0; color: var(--muted); font-size: 13px; }

    .win {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.65);
      pointer-events: auto;
      backdrop-filter: blur(6px);
    }
    .win .panel {
      width: min(520px, calc(100vw - 24px));
      background: rgba(20, 28, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 14px;
    }
    .win h2 { margin: 0 0 6px 0; font-size: 16px; color: var(--ok); }
    .win p { margin: 0 0 10px 0; color: var(--muted); font-size: 13px; }


    /* Inventory is a single-row horizontal strip; mobile uses swipe scrolling. */

    /* Prevent text selection on mobile */
    * { -webkit-tap-highlight-color: transparent; }

    /* MVP redesign controls panel (Chunk 5) */
    .ctrl{ margin-top:8px; padding:8px; border-radius:12px; background: rgba(12,16,26,0.55); border: 1px solid rgba(232,238,252,0.08); }
    .ctrlRow{ display:flex; flex-wrap:nowrap; gap:10px; align-items:center; }
    .ctrlPair{ display:flex; align-items:center; gap:8px; white-space:nowrap; }
    .costLabel{ display:inline-block; min-width:82px; text-align:left; font-variant-numeric: tabular-nums; }

    .ctrlRow label{ display:flex; gap:6px; align-items:center; font-size:12px; color: rgba(232,238,252,0.88); }
    .ctrlRow input[type="range"]{ accent-color: #7aa2ff; width: 120px; }
    .ctrlRow .val{ min-width:44px; text-align:right; font-variant-numeric: tabular-nums; color: rgba(232,238,252,0.85); }
    #objectivePanel{
    position:absolute;
    left:12px;
    top:64px;
    z-index:20;
    background:rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:10px;
    padding:8px 10px;
    color:#fff;
    font:12px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    max-width: calc(100vw - 24px);
    pointer-events:none;
  
    max-width: 260px;
    max-height: 220px;
    overflow:auto;
    font-size: 12px;
    line-height: 1.25;
  }
  #objectivePanel{ display:none; }
  #objectivePanel .title{font-weight:700; font-size:12px; margin-bottom:4px;}
  #objectivePanel .obj{opacity:0.92; margin-bottom:6px;}
  #objectivePanel .hold{opacity:0.92; margin-bottom:6px;}
  #objectivePanel .row{display:flex; gap:8px; align-items:baseline; margin:2px 0;}
  #objectivePanel .chk{width:14px; text-align:center; opacity:0.9;}
  #objectivePanel .h{flex:1; opacity:0.95;}
  #objectivePanel .v{opacity:0.9; font-variant-numeric:tabular-nums;}
  #objectivePanel .done{margin-top:6px; font-weight:700; color:#a7f3d0;}


  @media (max-width: 760px){
    .topbar{ grid-template-columns: 1fr; }
    .buttons{ flex-wrap: wrap; justify-content: flex-start; }
    .levelCtl{ flex: 1 1 auto; }
    .mvpHud{ white-space: pre-line; }
  }



  .drawerTop{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    pointer-events:auto;
  }
  #objectiveSummary{
    /* Two-column drawer: right block must stay on-screen */
    flex: 0 0 auto;
    max-width: 44vw;
    text-align: right;
    /* Allow next-step text to wrap/clamp instead of truncating to uselessness. */
    white-space: pre-line;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  /* Current-step instruction can be long; wrap/clamp instead of hard truncation. */
  #goalLine{
    /* Left block flexes and is allowed to shrink (min-width:0 prevents overflow) */
    flex: 1 1 auto;
    min-width: 0;
    white-space: pre-line;
    overflow: hidden;
    display: block;
  }
  #costSpinZero, #costZeroPair{
    display: inline-block;
    min-width: 78px;
    text-align: left;
  }

  /* A1: tighten ONLY the gap between pair cost and the pair button (snugger). */
  #costZeroPair{ margin-right: -12px; }

  /* A2/A3/A4: top banner styles + break flash */
  .notifyBar.bannerLose{
    background: rgba(120, 18, 26, 0.68);
    border-color: rgba(255, 90, 90, 0.25);
  }
  .notifyBar.bannerWin{
    background: rgba(14, 70, 34, 0.62);
    border-color: rgba(80, 220, 140, 0.20);
  }
  /* Keep controls visible in banner mode (WIN/LOSE must always be escapable). */
  .notifyBar.isBanner .notifyControls{ display:flex; }
  .notifyBar.isBanner .notifyText{ color: rgba(255,255,255,0.90); }
  .notifyBar.isBanner .patientInfo{ font-weight: 800; letter-spacing: 0.6px; }

  /* Break messages can be longer; allow more lines only for break mode. */
  .notifyBar.breakMode .notifyText{ -webkit-line-clamp: 4; white-space: pre-line; }
  .notifyText{ white-space: pre-line; }

  @keyframes breakFlash {
    0%{ box-shadow: 0 0 0 rgba(255,0,0,0); }
    25%{ box-shadow: 0 0 0 3px rgba(255, 60, 60, 0.32); }
    55%{ box-shadow: 0 0 0 3px rgba(255, 60, 60, 0.12); }
    100%{ box-shadow: 0 0 0 rgba(255,0,0,0); }
  }
  .notifyBar.flashBreak{ animation: breakFlash 0.75s ease-out; }

  .drawerLeft{ min-width: 220px; flex: 1 1 auto; }
  .drawerRight{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; flex: 0 0 auto; }
  .pill.big{ font-weight: 700; letter-spacing: 0.2px; }
  .miniBar{
    width: 180px;
    height: 6px;
    border-radius: 999px;
    background: rgba(232,238,252,0.10);
    overflow:hidden;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .miniBar > div{ height:100%; width:0%; background: rgba(122,162,255,0.95); border-radius: 999px; }

  /* Controls: tighter + wrap on narrow screens */
  .ctrlRow{ display:flex; gap:10px; align-items:center; flex-wrap:nowrap; }
  .ctrlRow label{ display:flex; align-items:center; gap:8px; }
  #deltaA{ width: 180px; }
  #deltaS{ width: 300px; }
  @media (max-width: 720px){
    #deltaS{ width: 240px; }
    #deltaA{ width: 160px; }
    .drawerRight{ align-items:flex-start; }
    .miniBar{ width: 160px; }
  }

  /* This pass: bottom controls compression (reclaim board space). */
  .drawer{ padding: 8px 10px; border-radius: 16px; }
  .drawerTop{ gap: 8px; margin-bottom: 6px; }
  .drawerTitleRow, #drawerSub, #selectedWellPill, #previewPill, #drawerEnergyLine{ display:none !important; }
  .drawerRight{ gap: 6px; }
  #energyCostPill{ font-size: 12px; padding: 6px 10px; }
  .pill{ padding: 6px 10px; }
  .ctrl{ margin-top: 6px; padding: 8px; }
  .ctrlRow{ gap: 8px; }
  .ctrlRow label{ gap: 6px; }
  .energyHud{ position: fixed; left: 12px; bottom: 180px; z-index: 25; font-size: 13px; padding: 6px 10px; border-radius: 999px; background: rgba(18,22,35,0.70); border: 1px solid rgba(255,255,255,0.10); color: rgba(232,238,252,0.92); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* Zen timer HUD (upper-right) */
  .zenTimerHud{ position: fixed; right: 12px; top: 68px; z-index: 25; font-size: 13px; padding: 6px 10px; border-radius: 999px; background: rgba(18,22,35,0.72); border: 1px solid rgba(255,255,255,0.12); color: rgba(255, 232, 170, 0.95); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing: 0.2px; box-shadow: 0 10px 28px rgba(0,0,0,0.35); pointer-events:none; display:none; }
  .zenTimerHud.visible{ display:block; }

  @media (max-width: 720px){ .energyHud{ bottom: 184px; }  #objectiveSummary{ max-width: 46vw; } }
  @media (max-width: 720px){ .zenTimerHud{ top: 62px; } }


    .breakCard{ width: min(640px, 100%); max-height: min(70vh, 520px); }
    .breakBody{ margin: 8px 0 10px; white-space: pre-wrap; font-size: 13px; line-height: 1.35; color: rgba(255,255,255,0.92); }

    /* Log overlay (opaque, pauses sim) */
    .logOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.82);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      pointer-events: auto;
    }
    .logOverlay.show{ display:flex; }
    .logCard{
      width: min(860px, calc(100vw - 24px));
      max-height: min(70vh, 560px);
      border-radius: 18px;
      background: rgba(20,28,43,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .logHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
        .logHeaderBtns{
      display:flex;
      align-items:center;
      gap: 8px;
    }

.logHeader h2{ margin:0; font-size: 16px; color: rgba(232,238,252,0.95); }
    .logBody{
      padding: 10px 12px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(232,238,252,0.86);
      white-space: pre-wrap;
    }
    .logEntry{ margin: 0 0 10px 0; padding: 8px 10px; border-radius: 12px; background: rgba(12,16,26,0.62); border: 1px solid rgba(255,255,255,0.08); }
    .logT{ color: rgba(232,238,252,0.70); font-variant-numeric: tabular-nums; }
    .logWell{ font-weight: 700; }
    .logWell.w0{ color: #ff6b6b; }
    .logWell.w1{ color: #b37cff; }
    .logWell.w2{ color: #7aa2ff; }
    .logWell.w3{ color: #54d18d; }
    .logWell.w4{ color: #ffd166; }
    .logWell.w5{ color: #ff9f43; }

  
    .patientInfo .hudLine1{ display:flex; flex-wrap:wrap; gap: 6px; align-items: baseline; }
    .hudPatientName{ font-weight: 800; font-size: 14px; color: rgba(232,238,252,0.96); margin-right: 6px; }
    .patientInfo .hudLine2{ margin-top: 2px; display:flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .patientInfo .hudLine3{ margin-top: 2px; min-height: 14px; font-size: 12px; font-weight: 800; color: var(--danger); letter-spacing: 0.6px; text-transform: uppercase; }
    .hudQuirkPill.hudQuirkTele{ filter: brightness(1.35); box-shadow: 0 0 10px rgba(255,255,255,0.14); animation: quirkTelePulse 0.9s ease-in-out infinite; }
    .hudQuirkPill.hudQuirkActive{ filter: brightness(1.65); box-shadow: 0 0 16px rgba(255,255,255,0.22); transform: translateY(-0.5px) scale(1.02); animation: quirkActivePulse 0.7s ease-in-out infinite; }
    @keyframes quirkTelePulse{ 0%,100%{ transform: translateY(0) scale(1.0); } 50%{ transform: translateY(-0.5px) scale(1.02);} }
    @keyframes quirkActivePulse{ 0%,100%{ transform: translateY(0) scale(1.02); } 50%{ transform: translateY(-1px) scale(1.05);} }

    /* DEV ONLY: Smoke runner panel */
    .smokePanel { position: fixed; left: 8px; top: 8px; width: 320px; max-width: calc(100vw - 16px); max-height: calc(100vh - 16px); overflow: hidden; z-index: 10000; pointer-events: auto; touch-action: manipulation; user-select: none; -webkit-user-select: none; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .smokePanel .smokeCard { background: rgba(12,16,26,0.88); border: 1px solid rgba(255,255,255,0.14); border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 10px; }
    .smokePanel .smokeTitle { font-weight: 800; font-size: 12px; color: rgba(232,238,252,0.92); margin: 0; letter-spacing: 0.6px; text-transform: uppercase; }
    .smokePanel .smokeBtns { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
    .smokePanel .smokeBtn { font-size: 12px; line-height: 1; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color: rgba(232,238,252,0.92); cursor: pointer; }
    .smokePanel .smokeBtn:active { transform: translateY(1px); }
    .smokePanel pre { margin: 0; height: 180px; overflow: auto; padding: 8px; border-radius: 10px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.10); color: rgba(232,238,252,0.86); font-size: 11px; white-space: pre-wrap; word-break: break-word; }
    .smokePanel .smokeRow { display:flex; gap: 6px; align-items:center; justify-content: space-between; margin-bottom: 6px; }
    .smokePanel .smokeStatus { font-size: 11px; font-weight: 800; color: rgba(232,238,252,0.82); }

  </style>
</head>
<body>
<div id="app"></div>

<!-- DEV ONLY: Smoke runner panel -->
<div id="smokePanel" class="smokePanel" aria-hidden="false">
  <div class="smokeCard">
    <div class="smokeRow">
      <div class="smokeTitle">Dev Smoke</div>
      <div id="smokeStatus" class="smokeStatus">IDLE</div>
    </div>
    <div class="smokeBtns">
      <button id="btnSmokeRun" class="smokeBtn">Run Smoke</button>
      <button id="btnSmokeStart" class="smokeBtn">Start Run</button>
      <button id="btnSmokeFF5" class="smokeBtn">Fast-forward 5s</button>
      <button id="btnSmokeFF30" class="smokeBtn">Fast-forward 30s</button>
      <button id="btnSmokeBreak" class="smokeBtn">Trigger Break</button>
      <button id="btnSmokeAck" class="smokeBtn">Ack Break</button>
      <button id="btnSmokeSwipeR" class="smokeBtn">Inject Swipe Right</button>
      <button id="btnSmokeSwipeU" class="smokeBtn">Inject Swipe Up</button>
      <button id="btnSmokeLobby" class="smokeBtn">Back to Lobby</button>
      <button id="btnSmokeClear" class="smokeBtn">Clear Log</button>
    </div>
    <pre id="smokeLog"></pre>
  </div>
</div>

<!-- Patient Lobby overlay (hidden until initialized) -->
  <div id="lobbyOverlay" class="lobbyOverlay" aria-hidden="true">
    <div class="lobbyCard">
      <div class="lobbyHeader">
        <h2>Patient Lobby</h2>
        <div class="sub" id="lobbyHint"></div>
      </div>

      <!-- Auth (minimal) -->
      <div class="lobbyAuth" id="lobbyAuth" aria-hidden="false">
        <button id="btnAuthSignIn" class="lobbyBtn">Sign in with Google</button>
        <div id="authUser" class="lobbyAuthUser" style="display:none;"></div>
        <div id="lobbyStartEnergy" class="lobbyStartEnergy">Starting Energy: 0</div>
        <button id="btnAuthSignOut" class="lobbyBtn" style="display:none;">Sign out</button>
      </div>

      <div class="lobbyDetails" id="lobbyDetails" aria-hidden="false">
        <div class="lobbyPortraitCol">
          <div class="lobbyPortraitWrap">
            <img id="lobbyPortraitImg" alt="Patient portrait" />
          </div>
          <div id="lobbyMilestones" class="lobbyMilestones"></div>
        </div>
        <div class="lobbyDetailsText">
          <div class="lobbyDetailsNameRow">
            <div class="lobbyDetailsName" id="lobbyDetailsName">—</div>
            <button id="btnLobbyPatientInfo" class="lobbyBtn lobbyInfoBtn" title="Patient info" aria-label="Patient info">?</button>
          </div>
          <div class="lobbyDetailsTagline" id="lobbyDetailsTagline"></div>
          <div class="lobbyDetailsMeta" id="lobbyDetailsMeta"></div>
          <div class="lobbyDetailsQuirks" id="lobbyDetailsQuirks"></div>
          <div id="lobbyDetailsHelp" class="lobbyDetailsHelp" style="display:none;"></div>
        </div>
      </div>
      <div id="patientList" class="patientList"></div>
      <div class="lobbyActions">
        <button id="btnLobbyHeroes" class="lobbyBtn">Heroes</button>
        <button id="btnLobbyTutorial" class="lobbyBtn" style="margin-right:auto;">Tutorial</button>
        <button id="btnLobbyResume" class="lobbyBtn" style="display:none;">Resume</button>
        <button id="btnLobbyStart" class="lobbyBtn primary">Start Session</button>
      </div>
    </div>
  </div>

<div class="hud">
  <div class="notifyBar" id="notifyBar" aria-live="polite">
    <div class="patientInfo" id="patientInfo"></div>
    <div class="notifyText" id="notifyText"></div>
    <div class="notifyControls" id="notifyControls">
      <button class="btn" id="btnDebug">Debug</button>
      <button class="btn" id="btnLog">Log</button>
      <button class="btn" id="btnLobby">Lobby</button>
    </div>
  </div>
  <div class="gestureDebugOverlay" id="gestureDebugOverlay"></div>
  <div class="topbar" id="topbar">
    <div class="meter" id="legacyMeters">
      <div class="label" id="collapseLabel">Collapse</div>
      <div class="bar"><div id="loseFill"></div></div>
      <div class="label" id="goalLabel" style="margin-top:6px;">Stabilization</div>
      <div class="bar"><div id="winFill"></div></div>
    </div>
    <div class="mvpHud" id="mvpHud"></div>
    <div class="buttons" aria-hidden="true"></div>
  </div>

  <!-- action line removed for MVP redesign (Chunk 5) -->

  <div class="debug" id="debug"></div>

  <div id="objectivePanel" aria-hidden="true"></div>

  
  <div class="energyHud" id="energyHud">⚡ 0/200</div>

  <div class="zenTimerHud" id="zenTimerHud" aria-hidden="true">ZEN 12:00</div>

<div class="drawer" id="drawer">
    <div class="drawerTop" style="margin-bottom:6px;">
      <div class="sub" id="goalLine">Current: —</div>
      <div class="sub" id="objectiveSummary">Next: —</div>
    </div>
    <div class="ctrl" id="ctrlPanel">
      <div class="ctrlRow" id="ctrlRow">
        <button class="btn" id="btnSpinZero">Set Spin 0</button>
        <span class="sub costLabel" id="costSpinZero">—</span>
        <span class="sub costLabel" id="costZeroPair">—</span>
        <button class="btn" id="btnZeroPair">Set Pair Spin 0</button>
      </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>



  <div class="win" id="win">
    <div class="panel">
      <h2>Mindform stabilized</h2>
      <p id="winReason">You held the line long enough for the currents to settle.</p>
      <div id="runSummary" style="white-space:pre-line; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 11px; color: rgba(232, 238, 252, 0.85); margin: 10px 0 12px 0;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="btnWinReset">New Run</button>
      </div>
    </div>
  </div>

  <div class="fail" id="fail">
    <div class="panel">
      <h2>Mindform destabilized</h2>
      <p id="failReason">Instability exceeded safe limits.</p>
      <div id="runSummaryFail" style="white-space:pre-line; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 11px; color: rgba(232, 238, 252, 0.85); margin: 10px 0 12px 0;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="btnFailReset">Reset Run</button>
      </div>
    </div>
  </div>
</div>

<!-- PixiJS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@7.4.2/dist/pixi.min.js"></script>

<!-- Firebase (compat / namespaced) for no-module builds -->
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>
<script src="./ec_bootstrap.js"></script>
<script src="./core_const.js"></script>
<script src="./core_tuning.js"></script>
<script src="./core_model.js"></script>
<script src="./core_action_math.js"></script>
<script src="./core_actions.js"></script>
<script src="./core_engine.js"></script>
<script src="./systems_firebase.js"></script>
<script src="./systems_sfx.js"></script>
<script src="./data_roster.js"></script>
<script src="./data_plans.js"></script>
<script src="./patients_plans.js"></script>
<script src="./systems_patients.js"></script>
<script src="./systems_traits.js"></script>
<script src="./systems_dispositions.js"></script>
<script src="./systems_breaks.js"></script>
<script src="./systems_input.js"></script>
<script src="./data_tutorial.js"></script>
<script src="./systems_tutorial.js"></script>
<script src="./render_wells_init.js"></script>
<script src="./render_wells_update.js"></script>
<script src="./render_wells.js"></script>
<script src="./core_mechanics.js"></script>
<script src="./ui_hud.js"></script>
<script src="./ui_lobby.js"></script>
<script src="./ui_controls.js"></script>
<script src="./ui_app.js"></script>
<script src="./main.js"></script>
  <script src="./dev_smoke.js"></script>

<!-- Log overlay (pauses gameplay while open) -->
<div id="logOverlay" class="logOverlay" aria-hidden="true">
  <div class="logCard">
    <div class="logHeader">
      <h2>Log</h2>
      <div class="logHeaderBtns">
        <button class="btn" id="btnLogCopy">Copy</button>
        <button class="btn" id="btnLogClose">Close</button>
      </div>
    </div>
    <div id="logBody" class="logBody"></div>
  </div>
</div>

<!-- Break modal overlay (gameplay pause) -->
  <div id="breakOverlay" class="lobbyOverlay" aria-hidden="true">
    <div class="lobbyCard breakCard">
      <div class="lobbyHeader">
        <h2 id="breakTitle">Mental Break</h2>
      </div>
      <pre id="breakBody" class="breakBody"></pre>
      <div class="lobbyFooter">
        <button id="breakOk" class="lobbyBtn">OK</button>
      </div>
    </div>

  </div>

</body>
</html>
