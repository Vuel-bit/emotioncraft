Emotioncraft Psyche MVP
Build: emotioncraft_v0_2_103_passD_passA25_edgesSpinAlive
Date: 2026-02-18

Highlights (current build)
- Pass A19: Added EC.SIM_BOOT.ensure() and replaced duplicate SIM array init in core_mechanics (structural only; no gameplay changes).
- Pass A18: Added dev_smoke.html + dev_smoke.js smoke runner page (dev-only; index.html unaffected).
- Pass A16: Patient session transitions (beginFromLobby/startPending/resume/openPause/backToLobby) are routed through ENGINE.dispatch/ACTIONS wrappers to keep patient-session root writes bracketed for simguard.
- Pass A15: init/reset entry points (resetRun + initMVP) routed through ENGINE.dispatch/ACTIONS so SIM write-guard brackets startup/reset writes.
- Pass A14: SIM write-guard now records up to 10 sample writes (key + tag chain) and the Debug panel always shows top 5 suspicious keys when ?simguard=1 is enabled (samples shown only in ?inputdebug=1).
- Pass A12: Added EC.ACTIONS.setUiPaused and routed Log overlay pause toggling through ENGINE.dispatch/ACTIONS (ui_hud no longer writes SIM._uiPaused). ui_hud init handlers use snapshot locals; ui_app seeds ctx from snapshot. No behavior changes.
- Pass A10: Begin read-surface migration. ENGINE.getSnapshot now guarantees {SIM, UI_STATE, RENDER_STATE}; HUD/Controls/Render-Wells read via snapshot locals.
- Pass A11: Continue read-surface migration. render_wells/render_wells_init/systems_input/ui_lobby now read via EC.ENGINE.getSnapshot() locals (fallback _snap per file).
- Pass A9: SIM write-guard improvements — tag chaining uses '>' for nested contexts; action wrapper avoids redundant nested bracketing; debug overlay shows sim-guard suspicious-write totals (and top keys in verbose inputdebug).
- Pass A8: Tick split into EC.tickEngine (sim) + EC.tickUI (presentation). EC.ENGINE.tick brackets only tickEngine; UI runs outside bracket for SIM write-guard fidelity.
- Pass A7: Optional debug SIM root write-guard (?simguard=1 or UI_STATE.debugStrict). Warns on SIM root writes outside ENGINE dispatch/tickEngine; ticker prefers EC.ENGINE.tick; direct actions are bracketed.
- Pass A6: Control-sync stamps moved from SIM to EC.UI_STATE; engine systems route inLobby via EC.ACTIONS.setInLobby (single write point).
- Pass A5: Selection is UI-only (EC.UI_STATE.selectedWellIndex); SIM selectedWellIndex removed.
- Pass A2: UI/presentation no longer writes to EC.SIM directly for common toggles and break modal ack (uses EC.ENGINE/EC.ACTIONS).
- Pass A3: Canonical selected well moved to EC.UI_STATE.selectedWellIndex; presentation reads prefer UI_STATE.
- Pass A4: Lobby no longer mutates SIM.inLobby directly; ui_lobby routes via EC.ENGINE.dispatch('setInLobby') / EC.ACTIONS.setInLobby.
- Lobby-driven patient loop. Intake is treated as complete for all patients (no Intake gating). Choose WEEKLY / ZEN / TRANQUILITY; TRANSCENDENCE unlocks only after Zen + Tranquility are completed for that patient.
- Patient WIN auto-returns to Lobby to show post-win popups (no SUCCESS banner). LOSE does not auto-return.
- Psyche is per-hue only (0..500 each). Center core is the Treatment hold timer ring + countdown; it flashes red on mental breaks.
- PLAN_CHAIN: psyche comparisons use rounded values (matches HUD numbers) and each plan step can define holdSec (default 10s; 0s for no-hold steps). INTAKE Step 3 is no-hold; WEEKLY is 3 steps (no spin-zero step).
- Timed plans: ZEN / TRANQUILITY / TRANSCENDENCE run on a 10:00 timer (shown as a small pill in the top-right HUD). Timer-expiry loss reason is exactly: "Time expired."
- Mental breaks: first-time-only popups pause and explain break types; break mechanics remain as before (quirks cancelled + ramp timers reset; ~0.5s hit-stop; center flash + affected wells/hues pulse; break details append to the Log overlay).
- Quirks: Fixates (Amount up), Crashes (Amount down), Obsesses (Spin to +100), Spirals (Spin to -100). Telegraph + active phases. Random scheduling uses per-template per-second ramp chances (tier steps 0.00025 / 0.0005 / 0.001) (0.025% / 0.05% / 0.1% per sec), resetting only when that quirk instance ends; capped to at most one newly scheduled quirk per second; global min-gap still applies.
- Debug: default debug panel shows event-based Quirk timeline (mm:ss, type, tier label, well, unshielded force, duration, gap), capped 60. Debug overlay includes a Copy Debug button to copy the current debug text.
- Lobby: Heroes button shows transcended patients (completed TRANSCENDENCE). Lobby details panel shows small badges when Zen and/or Tranquility are completed.
- Lobby: Tutorial button launches a sessionless mechanics walkthrough (no patient slot; no save/progression). Tutorial ends via a completion modal button and disables spillover + mental breaks.
- Lobby: “?” toggle shows detailed explanations for the selected patient’s Mood/Vibe/Traits/Quirks.
- Pass 24: Added EC.ACTIONS facade (core_actions.js). Routed flick/swipe + Spin0/Pair0 through EC.ACTIONS (no behavior changes).
- Pass 25: Implemented EC.ACTIONS as authoritative (no UI delegation). UI controls wrap actions; added controls sync stamp for slider resync.

Run root: open docs/index.html
- Pass 26: Extracted EC.ACTION_MATH (canonical preview/cost/unit rounding/pair cost). Routed ACTIONS + UI controls to it to prevent drift.
- Pass 27: Added app_loop.js (EC.APP.tickMvp). core_mechanics EC.tick delegates MVP branch to app loop (no behavior changes; later inlined).
- Pass 28: Added MVP pipeline module (stepMvp). core_mechanics MECH.step delegates MVP systems ordering to pipeline (no behavior changes).
- Pass 29: Hotfix — Hue Break no longer references undefined msg; MVP tick will not fall through into legacy unless SIM.wells exists.
- Pass 30: Legacy tick removed (MVP-only runtime). Inlined MVP tick into core_mechanics and deleted app_loop.js. Removed dead legacy tick helpers and unused legacy render swirl step.
- Pass 31: Inlined MVP pipeline into core_mechanics and removed the pipeline layer (no behavior changes).
- Pass 32: Removed legacy Imprint/Trauma/Cleanse prototype system (no gameplay changes).

- Pass 33: Removed legacy SIM.wells well-view renderer and deleted dependent core_model display/well helpers. render_wells is now MVP-only (layout + psyche + resize). (No gameplay changes.)
- Pass 34: Removed stray render_wells.js.bak; moved gesture helpers + DOM pointer bridge to systems_input; removed final legacy SIM.wells fallback from input (no behavior changes).
- Pass 35: Main.js hygiene: removed inline input debug ladder; moved input debug recorders + touchstart arming helper into systems_input; standardized inputDbg bucket (no gameplay changes).
- Pass 36: Extracted patient roster to data_roster.js (EC.DATA.ROSTER). systems_patients consumes roster from EC.DATA (no behavior changes).
- Pass 37: Extracted plan specs to data_plans.js (EC.DATA.PLANS); systems_patients consumes EC.DATA.PLANS.
- Pass 38: Extracted tutorial def + step specs/copy to data_tutorial.js (EC.DATA.TUTORIAL); systems_tutorial consumes EC.DATA.TUTORIAL (no behavior changes).
- Pass 39: Hotfix — canonical input release resolver shared by DOM pointer + touch (restores desktop long-press drag scaling); weekly win reliably triggers reward overlay via planKey normalization; gesture coords/debug hidden by default (?inputdebug=1).
- Pass 40: Stage pointer-up fallback now routes through canonical release resolver (removes duplicate flick-only logic). Weekly fallback label preserved. No behavior changes.
- Pass 41: Tranquility thresholds/bands updated (data-only). Spill/break info popups now persist once-per-player via Firestore ui.seenFirstPopups (still session-only when signed out).

- Pass A1: Added core_engine.js (EC.ENGINE facade) and wired into index.html. Began enforcing boundary: presentation modules route SIM writes via EC.ENGINE.dispatch / EC.ACTIONS (selectWell migrated). Render-only layout state (mvpGeom, psycheRadius) moved to EC.RENDER_STATE.layout.
- Pass A17: Hotfix — Weekly reward overlay restored; template expander supports swapped $LO_SET/$HI_SET markers (Weekly A Step 2 goals).
- Pass A18: Added dev_smoke.html + dev_smoke.js smoke runner page (dev-only).
- Pass A19: Added EC.SIM_BOOT.ensure() and replaced duplicate SIM array init in core_mechanics (structural only).
- Pass A20: Added EC.require deferred init hooks + improved assertReady missing-path reporting (structural only).
Pass A21: Extracted treatment plan runtime into patients_plans.js; systems_patients.js now delegates (no behavior change).
Pass A22: Render-only wells upgrade — nebula/energy interior FX (displacement warp + wisps + subtle glow). No gameplay changes.
Pass A23: Render-only wells update — water/fluid interior FX (refraction + caustics + spec + fresnel rim). No gameplay changes.
Pass A24: Render-only wells update — crisper bowl edge rim (two-pass definition rim + slightly stronger FX fresnel rim). No gameplay changes.
Pass A25: Render-only wells update — bevel-like 3-pass baseline rim, fixed spin=0 CW bias, ~5x visual spin read at spin=100, always-alive interior; any outside-edge shading gated to high spins only. No gameplay changes.
